#!/bin/bash

BUILD_ROOT=$(realpath "${BASH_SOURCE[0]%/*}/..")
ENV_FILE="$BUILD_ROOT/.env"

# Check if .env exists
if [[ ! -f "$ENV_FILE" ]]; then
  echo "Error: .env file not found at $ENV_FILE"
  echo "Please create a .env file with your Cloudflare R2 credentials:"
  echo "  S3_ENDPOINT=https://ACCOUNT_ID.r2.cloudflarestorage.com"
  echo "  S3_ACCESS_KEY_ID=your_access_key_id"
  echo "  S3_SECRET=your_secret_access_key"
  exit 1
fi

# Load environment variables from .env
source "$ENV_FILE"

# Validate required variables
if [[ -z "$S3_ENDPOINT" || -z "$S3_ACCESS_KEY_ID" || -z "$S3_SECRET" ]]; then
  echo "Error: Missing required variables in .env file"
  echo "Required: S3_ENDPOINT, S3_ACCESS_KEY_ID, S3_SECRET"
  exit 1
fi

# Create rclone config directory
mkdir -p ~/.config/rclone

# Generate rclone config
cat > ~/.config/rclone/rclone.conf << EOF
[Aura]
type = s3
provider = Cloudflare
access_key_id = $S3_ACCESS_KEY_ID
secret_access_key = $S3_SECRET
endpoint = $S3_ENDPOINT
EOF

echo "âœ“ rclone configured successfully for Cloudflare R2"
echo "  Endpoint: $S3_ENDPOINT"
echo "  Config: ~/.config/rclone/rclone.conf"
